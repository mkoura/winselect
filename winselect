#!/usr/bin/env bash

##
## Display list of windows managed by the window manager (using dmenu) and switch to the selected window.
##
## When launched with '-c' option, display only windows on current desktop.
##
## Author: Martin Kourim <misc.kourim@gmail.com>
## License: Public Domain


curdonly=0

case "$1" in
  '-c'|'c') curdonly=1 ; shift ;;
  '-help'|'--help'|'help') echo "usage: ${0##*/} [-c] [--help] DMENU_OPTIONS" >&2; exit 0 ;;
esac

type wmctrl >/dev/null 2>&1 || { echo "wmctrl command missing"; exit 1; }
type dmenu  >/dev/null 2>&1 || { echo "dmenu command missing"; exit 1; }


# current desktop id
cur_desktop="$(wmctrl -d | while read num curr dis; do [ "$curr" = "*" ] && { echo "$num"; break; }; done)"

# array of window ids
winid=()

# array of window titles
wintit=()


# populate arrays
save_win() {
  rv=0
  # print only windows on current desktop or sticky windows when "-c" was specified
  if [ "$curdonly" = 1 ]; then
    [ "$2" = "$cur_desktop" -o "$2" = '-1' ] || rv=1
  fi

  if [ "$rv" = 0 ]; then
    wintit[${1}]="${1}:[${3}]"
    winid[${1}]="$4"
  fi

  return "$rv"
}


# use wmctrl to display list of running clients and their window titles
# prefixed with desktop number
winlist() {
  # titles of all windows
  i=1
  while read id num class mach title; do
    if [ "${#title}" -le 40 ]; then
      tit="$title"
    else
      # if the window title is too long, replace the middle of the string with ...
      tit="$(echo "$title" | sed -n 's/^\(.\{14,17\}\).*\(.\{14,20\}\)$/\1...\2/p')"
    fi
    save_win "$i" "$num" "$tit" "$id" && ((i++))
  done < <(wmctrl -l -x) # avoid subshell
}


# match window title returned by dmenu with actual window and switch to it
winlist_match() {
  # prefix number (from e.g. "2:[window title]")
  pref="${@%%:[*}"
  [ -z "$pref" ] && return 0
  wmctrl -i -a "${winid[$pref]}"
}


winlist

title="$(
  i=1
  while [ "$i" -le "${#wintit[@]}" ]; do
    echo "${wintit[$i]}"
    ((i++))
  done | tr '[:upper:]' '[:lower:]' | dmenu "$@"
)"

winlist_match "$title"


# vim: set noai et sr ts=2 sw=2 sts=2:
